<!DOCTYPE html>
<html>
<head>
    <title>Image Resizer</title>
    <style>
        body.noscroll {
            position: fixed;
            overflow-x: hidden;
            overflow-y: hidden;
            width: 100%;
        }
    </style>
    <script>
        let imgUrl, imgwidth, imgheight, uniqueId;

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function fn() {
            uniqueId = getQueryParam('id') || 'default'; 

            // Select elements using data attributes
            const imgElement = document.querySelector(`[data-iframe-id="default"]`);
            const linkElement = document.querySelector(`[data-link-id="default"]`);
            const tdElement = document.querySelector(`[data-td-id="default"]`);

            if (imgElement) imgElement.setAttribute("data-iframe-id", uniqueId);
            if (linkElement) linkElement.setAttribute("data-link-id", uniqueId);
            if (tdElement) tdElement.setAttribute("data-td-id", uniqueId);

            // Update selectors
            const imageSelector = `[data-iframe-id="${uniqueId}"]`;
            const linkSelector = `[data-link-id="${uniqueId}"]`;
            const tdSelector = `[data-td-id="${uniqueId}"]`;

            imgUrl = getQueryParam('img') || "https://difemaro.github.io/Resize/no_image.png";
            const img = document.querySelector(imageSelector);
            const link = document.querySelector(linkSelector);
            const td = document.querySelector(tdSelector);

            if (!img) return;

            img.src = imgUrl; // Set the image URL first

            img.onload = function () {
                imgwidth = img.naturalWidth;
                imgheight = img.naturalHeight;

                if (imgwidth === 0 || imgheight === 0) {
                    console.warn(`Image ${imgUrl} did not load properly.`);
                    return;
                }

                resizeImage(img, td);
            };

            // Set link attributes if available
            const linkUrl = getQueryParam('link');
            if (linkUrl && link) {
                link.href = linkUrl;
                if (getQueryParam('target') === "new") {
                    link.target = "_blank";
                }
            }

            // Set background color if available
            const background = getQueryParam('color');
            if (background) {
                document.body.style.backgroundColor = background;
            }
        }

        function resizeImage(img, td) {
            let w = document.body.offsetWidth;
            let h = document.documentElement.offsetHeight;
            let h2 = document.body.offsetHeight;
            let h3 = window.innerHeight;

            if (h < h2) h = h2;
            if (h3 !== 'undefined' && h < h3) h = h3;

            if (td) {
                td.style.height = h + 'px';
            }

            if (imgwidth / w <= imgheight / h) {
                w = imgwidth * h / imgheight;
            } else {
                h = imgheight * w / imgwidth;
            }

            img.width = w;
            img.height = h;
        }

        // Resize on window resize event
        window.onresize = function () {
            const img = document.querySelector(`[data-iframe-id="${uniqueId}"]`);
            const td = document.querySelector(`[data-td-id="${uniqueId}"]`);
            if (img && imgwidth && imgheight) {
                resizeImage(img, td);
            }
        };
    </script>
</head>

<body onload="fn()" class="noscroll" style="margin:0px;background-color:white;">
    <table style="width:100%;border-spacing:0px">
        <tbody>
            <tr>
                <td data-td-id="default" style="text-align:center;padding:0px">
                    <a data-link-id="default" target="_top" href="">
                        <img src='' data-iframe-id="default" alt="Click to open image in new window"/>
                    </a>
                </td>
            </tr>
        </tbody>
    </table>
</body>
</html>
